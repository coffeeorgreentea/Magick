FROM node:18-alpine

WORKDIR /app

ARG DATABASE_URL
ARG NODE_OPTIONS
ARG JWT_SECRET
ARG DUMMY_TOKEN
ARG DEFAULT_OPENAI_KEY
ARG DEFAULT_GOOGLEAI_API_KEY
ARG AWS_ACCESS_KEY
ARG AWS_SECRET_KEY
ARG AWS_REGION
ARG AWS_BUCKET_NAME
ARG AWS_BUCKET_ENDPOINT
ARG CLOUD_AGENT_KEY
ARG CLIENT_PLUGINS
ARG SERVER_PLUGINS
ARG VITE_APP_FILE_SERVER_URL
ARG VITE_APP_SPEECH_SERVER_URL
ARG VITE_APP_TRUSTED_PARENT_URL
ARG VITE_APP_POSTHOG_ENABLED
ARG VITE_APP_POSTHOG_API_KEY
ARG POSTHOG_API_KEY
ARG VITE_APP_PRODUCTION
ARG PRODUCTION
ARG VITE_APP_STANDALONE
ARG STANDALONE
ARG REDISCLOUD_HOST
ARG REDISCLOUD_URL
ARG OPENMETER_ENABLED
ARG OPENMETER_TOKEN
ARG OPENMETER_ENDPOINT
ARG OPENMETER_SOURCE
ARG UNSTRUCTURED_ENDPOINT
ARG PAGINATE_DEFAULT
ARG PAGINATE_MAX

ENV DATABASE_URL=${DATABASE_URL}
ENV NODE_OPTIONS=${NODE_OPTIONS}
ENV JWT_SECRET=${JWT_SECRET}
ENV DUMMY_TOKEN=${DUMMY_TOKEN}
ENV DEFAULT_OPENAI_KEY=${DEFAULT_OPENAI_KEY}
ENV DEFAULT_GOOGLEAI_API_KEY=${DEFAULT_GOOGLEAI_API_KEY}
ENV AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
ENV AWS_SECRET_KEY=${AWS_SECRET_KEY}
ENV AWS_REGION=${AWS_REGION}
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
ENV AWS_BUCKET_ENDPOINT=${AWS_BUCKET_ENDPOINT}
ENV CLOUD_AGENT_KEY=${CLOUD_AGENT_KEY}
ENV CLIENT_PLUGINS=${CLIENT_PLUGINS}
ENV SERVER_PLUGINS=${SERVER_PLUGINS}
ENV VITE_APP_FILE_SERVER_URL=${VITE_APP_FILE_SERVER_URL}
ENV VITE_APP_SPEECH_SERVER_URL=${VITE_APP_SPEECH_SERVER_URL}
ENV VITE_APP_TRUSTED_PARENT_URL=${VITE_APP_TRUSTED_PARENT_URL}
ENV VITE_APP_POSTHOG_ENABLED=${VITE_APP_POSTHOG_ENABLED}
ENV VITE_APP_POSTHOG_API_KEY=${VITE_APP_POSTHOG_API_KEY}
ENV POSTHOG_API_KEY=${POSTHOG_API_KEY}
ENV VITE_APP_PRODUCTION=${VITE_APP_PRODUCTION}
ENV PRODUCTION=${PRODUCTION}
ENV VITE_APP_STANDALONE=${VITE_APP_STANDALONE}
ENV STANDALONE=${STANDALONE}
ENV REDISCLOUD_HOST=${REDISCLOUD_HOST}
ENV REDISCLOUD_URL=${REDISCLOUD_URL}
ENV OPENMETER_ENABLED=${OPENMETER_ENABLED}
ENV OPENMETER_TOKEN=${OPENMETER_TOKEN}
ENV OPENMETER_ENDPOINT=${OPENMETER_ENDPOINT}
ENV OPENMETER_SOURCE=${OPENMETER_SOURCE}
ENV UNSTRUCTURED_ENDPOINT=${UNSTRUCTURED_ENDPOINT}
ENV PAGINATE_DEFAULT=${PAGINATE_DEFAULT}
ENV PAGINATE_MAX=${PAGINATE_MAX}

RUN apk update \
    && apk add --no-cache

COPY package*.json ./
COPY scripts /app/scripts
COPY ./dist/apps/server /app/dist/apps/server

RUN npm ci  --legacy-peer-deps --ignore-scripts

CMD [ "node", "/app/dist/apps/server/main.js" ]
