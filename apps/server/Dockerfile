FROM node:18-alpine

# Create app directory
WORKDIR /app

ARG DATABASE_URL
ARG NODE_OPTIONS
ARG JWT_SECRET
ARG DUMMY_TOKEN
ARG DEFAULT_OPENAI_KEY
ARG DEFAULT_GOOGLEAI_API_KEY
ARG AWS_ACCESS_KEY
ARG AWS_SECRET_KEY
ARG AWS_REGION
ARG AWS_BUCKET_NAME
ARG AWS_BUCKET_ENDPOINT
ARG CLOUD_AGENT_KEY
ARG CLIENT_PLUGINS
ARG SERVER_PLUGINS

ENV DATABASE_URL=${DATABASE_URL}
ENV NODE_OPTIONS=${NODE_OPTIONS}
ENV JWT_SECRET=${JWT_SECRET}
ENV DUMMY_TOKEN=${DUMMY_TOKEN}
ENV DEFAULT_OPENAI_KEY=${DEFAULT_OPENAI_KEY}
ENV DEFAULT_GOOGLEAI_API_KEY=${DEFAULT_GOOGLEAI_API_KEY}
ENV AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
ENV AWS_SECRET_KEY=${AWS_SECRET_KEY}
ENV AWS_REGION=${AWS_REGION}
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
ENV AWS_BUCKET_ENDPOINT=${AWS_BUCKET_ENDPOINT}
ENV CLOUD_AGENT_KEY=${CLOUD_AGENT_KEY}
ENV CLIENT_PLUGINS=${CLIENT_PLUGINS}
ENV SERVER_PLUGINS=${SERVER_PLUGINS}

RUN apk update \
    && apk add --no-cache

COPY package*.json ./
COPY scripts /app/scripts
COPY ./dist/apps/server /app/dist/apps/server

RUN npm ci  --legacy-peer-deps --ignore-scripts

CMD [ "node", "/app/dist/apps/server/main.js" ]
